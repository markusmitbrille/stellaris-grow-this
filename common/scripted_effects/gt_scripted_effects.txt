@gt_monthly_delta     =  0.1

@gt_wealth_criminal   = -5.0
@gt_wealth_unemployed = -3.0
@gt_wealth_worker     = -2.0
@gt_wealth_specialist =  1.0
@gt_wealth_ruler      =  6.0

# this = planet
gt_remove_planet_wealth = {
  clear_variable = gt_var_wealth
  remove_modifier = gt_mod_wealthy
  remove_modifier = gt_mod_poor
}

# this = pop
gt_remove_pop_wealth = {
  clear_variable = gt_var_wealth
}

# this = planet
gt_update_planet_wealth = {
  # reset wealth
  set_variable = { which = gt_var_wealth value = 0 }

  # remove old modifiers
  remove_modifier = gt_mod_wealthy
  remove_modifier = gt_mod_poor

  # sum up pop wealth
  every_owned_pop = {
    limit = { is_variable_set = gt_var_wealth }
    planet = {
      change_variable = { which = gt_var_wealth value = prev.gt_var_wealth }
    }
  }

  # add poor modifier multiplied by wealth
  if = {
    limit = { check_variable = { which = gt_var_wealth value < -10 } }

    # cap at 100
    if = {
      limit = { check_variable = { which = gt_var_wealth value < -100 } }
      add_modifier = {
        modifier = gt_mod_poor
        multiplier = -100
      }
    }
    else = {
      add_modifier = {
        modifier = gt_mod_poor
        multiplier = gt_var_wealth
      }
    }
  }

  # add wealthy modifier multiplied by wealth
  if = {
    limit = { check_variable = { which = gt_var_wealth value > 10 } }

    # cap at 100
    if = {
      limit = { check_variable = { which = gt_var_wealth value > 100 } }
      add_modifier = {
        modifier = gt_mod_wealthy
        multiplier = 100
      }
    }
    else = {
      add_modifier = {
        modifier = gt_mod_wealthy
        multiplier = gt_var_wealth
      }
    }
  }
}

# this = pop
gt_update_pop_wealth = {
  # set wealth variable if unset
  if = {
    limit = { NOT = { is_variable_set = gt_var_wealth } }
    set_variable = { which = gt_var_wealth value = 0 }
  }

  # set target wealth based on pop category
  switch = {
    trigger = is_pop_category

    criminal = {
      set_variable = { which = gt_local_change value = @gt_wealth_criminal }
    }
    worker = {
      set_variable = { which = gt_local_change value = @gt_wealth_worker }
    }
    specialist = {
      set_variable = { which = gt_local_change value = @gt_wealth_specialist }
    }
    ruler = {
      set_variable = { which = gt_local_change value = @gt_wealth_ruler }
    }
    default = {
      set_variable = { which = gt_local_change value = 0 }
    }
  }

  # unemployed pops always lose wealth
  if = {
    limit = { is_unemployed = yes }
    set_variable = { which = gt_local_change value = @gt_wealth_unemployed }
  }

  # change toward target wealth by fraction of difference
  subtract_variable = { which = gt_local_change value =  gt_var_wealth }
  multiply_variable = { which = gt_local_change value = @gt_monthly_delta }
  change_variable   = { which = gt_var_wealth   value =  gt_local_change }

  # clear local variable
  clear_variable = gt_local_change
}